
<script type="text/x-red" data-template-name="ezlo item">
    <div class="form-row">
        <label for="node-input-hub"><i class="fa fa-globe"></i> <span data-i18n="ezlo.label.hub">Hub</span></label>
        <input type="text" id="node-input-hub">
    </div>
    <div class="form-row">
        <label for="node-input-itemId"><i class="fa fa-tag"></i> <span data-i18n="ezlo.label.itemid"></span></label>
        <input type="text" id="node-input-itemId" data-i18n="[placeholder]ezlo.placeholder.itemid">
    </div>
    <div class="form-row">
        <select id="ezlo-device">
            <option value="">Loading...</option>
        </select>
        <select id="ezlo-item">
            <option value="">Loading...</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-description"><i class="fa fa-comment"></i> <span data-i18n="ezlo.label.description"></span></label>
        <input type="text" id="node-input-description" data-i18n="[placeholder]ezlo.placeholder.itemdescription">
    </div>
    <div class="form-row">
        <label style="width: auto;" for="node-input-responseType"><i class="fa fa-send"></i> <span data-i18n="ezlo.label.outputformat"></span></label>
        <select id="node-input-responseType" style="width: auto">
            <option value="" data-i18n="ezlo.item-response.simple"></option>
            <option value="abbr" data-i18n="ezlo.item-response.abbr"></option>
            <option value="full" data-i18n="ezlo.item-response.full"></option>
        </select>
    </div>
</script>

<script type="text/x-red" data-template-name="ezlo device">
    <div class="form-row">
        <label for="node-input-hub"><i class="fa fa-globe"></i> <span data-i18n="ezlo.label.hub"></span></label>
        <input type="text" id="node-input-hub">
    </div>
    <div class="form-row">
        <label for="node-input-deviceId"><i class="fa fa-tag"></i> <span data-i18n="ezlo.label.deviceid"></span></label>
        <input type="text" id="node-input-deviceId" data-i18n="[placeholder]ezlo.placeholder.deviceid">
    </div>
    <div class="form-row">
        <select id="ezlo-device">
            <option value="">Loading...</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-description"><i class="fa fa-comment"></i> <span data-i18n="ezlo.label.description"></span></label>
        <input type="text" id="node-input-description" data-i18n="[placeholder]ezlo.placeholder.devicedescription">
    </div>
</script>

<script type="text/x-red" data-template-name="ezlo house mode">
    <div class="form-row">
        <label for="node-input-hub"><i class="fa fa-globe"></i> <span data-i18n="ezlo.label.hub"></span></label>
        <input type="text" id="node-input-hub">
    </div>
    <div class="form-row">
        <label style="width: auto;" for="node-input-responseType"><i class="fa fa-send"></i> <span data-i18n="ezlo.label.outputformat"></span></label>
        <select id="node-input-responseType" style="width: auto">
            <option value="" data-i18n="ezlo.housemode-response.name"></option>
            <option value="id" data-i18n="ezlo.housemode-response.id"></option>
            <option value="curr" data-i18n="ezlo.housemode-response.curr"></option>
            <option value="full" data-i18n="ezlo.housemode-response.full"></option>
        </select>
    </div>
</script>

<script type="text/x-red" data-template-name="ezlo hub info">
    <div class="form-row">
        <label for="node-input-hub"><i class="fa fa-globe"></i> <span data-i18n="ezlo.label.hub"></span></label>
        <input type="text" id="node-input-hub">
    </div>
</script>

<script type="text/html" data-template-name="ezlo-hub">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="ezlo.label.name"></span></label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]ezlo.placeholder.name">
    </div>
    <div class="form-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="node-config-ezlo-hub-tabs"></ul>
    </div>
    <div id="node-config-ezlo-hub-tabs-content" style="min-height: 150px;">
        <div id="ezlo-hub-tab-connection" style="display: none">
            <div class="form-row">
                <label for="node-config-input-serialNumber"><i class="fa fa-id-card-o"></i> <span data-i18n="ezlo.label.serialNumber"></span></label>
                <input type="text" id="node-config-input-serialNumber" style="width: auto" data-i18n="[placeholder]ezlo.label.serialExample">
            </div>
            <div class="form-row" style="margin-bottom:0">
                <input type="checkbox" id="node-config-input-autoConnect" style="margin: 0 5px 0 104px; display: inline-block; width: auto;">
                <label for="node-config-input-autoConnect" style="width: auto"><span data-i18n="ezlo.label.autoConnect"</span></label>
            </div>
            <div class="form-row">
                <label for="node-config-input-localIP"><i class="fa fa-at"></i> <span data-i18n="ezlo.label.localIP"></span></label>
                <input type="text" id="node-config-input-localIP" style="width: auto;" data-i18n="[placeholder]ezlo.label.ipExample">
            </div>
        </div>
        <div id="ezlo-hub-tab-security" style="display:none">
            <div class="form-row">
                <label for="node-config-input-username"><i class="fa fa-user"></i> <span data-i18n="ezlo.label.username"></span></label>
                <input type="text" id="node-config-input-username">
            </div>
            <div class="form-row">
                <label for="node-config-input-password"><i class="fa fa-lock"></i> <span data-i18n="ezlo.label.password"></span></label>
                <input type="password" id="node-config-input-password">
            </div>
        </div>
        <div id="ezlo-hub-tab-options" style="display:none">
            <div class="form-row">
                <label style="width: auto;" for="node-config-input-accessAnonymous"><i class="fa fa-cog"></i> <span data-i18n="ezlo.label.accessAnonymous"></span></label>
                <select id="node-config-input-accessAnonymous" style="width: auto">
                    <option value="" data-i18n="ezlo.options.anonUnchanged"></option>
                    <option value="false" data-i18n="ezlo.options.anonEnable"></option>
                    <option value="true" data-i18n="ezlo.options.anonDisable"></option>
                </select>
            </div>
            <div class="form-row" style="margin-bottom:0">
                <input type="checkbox" id="node-config-input-debug" style="margin: 0 5px 0 104px; display: inline-block; width: auto;">
                <label for="node-config-input-debug" style="width: auto"><span data-i18n="ezlo.label.debug"></span></label>
            </div>
        </div>
    </div>
</script>

<!-- ------------------------------------------------------------------------------------------ -->

<script type="text/javascript">
/* jshint esversion:8,browser:true */
/* global RED,$ */
(function() {

    RED.nodes.registerType('ezlo-hub',{
        category: 'config',
        defaults: {
            name: { value: "", required: false },
            serialNumber: { value:"", required: true },
            localIP: { value: "", required: false },
            autoConnect: { value: false, required: false },
            accessAnonymous: { value: "" },
            debug: { value: false, required: false }
        },
        credentials: {
            username: { type: "text" },
            password: { type: "password" }
        },
        label: function() {
            if ( "" !== ( this.name || "" ) ) {
                return this.name;
            }
            return this.serialNumber;
        },
        oneditprepare: function () {
            var tabs = RED.tabs.create({
                id: "node-config-ezlo-hub-tabs",
                onchange: function(tab) {
                    $("#node-config-ezlo-hub-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            tabs.addTab({
                id: "ezlo-hub-tab-connection",
                label: this._("ezlo.tabs-label.connection") || "Connection"
            });
            tabs.addTab({
                id: "ezlo-hub-tab-security",
                label: this._("ezlo.tabs-label.security") || "Security"
            });

            tabs.addTab({
                id: "ezlo-hub-tab-options",
                label: this._("ezlo.tabs-label.options") || "Options"
            });

            setTimeout(function() { tabs.resize(); },0);

            if ( "undefined" === typeof this.accessAnonymous ) {
                this.accessAnonymous = null;
                $("#node-config-input-accessAnonymous").val( "" );
            }
            if ( "undefined" === typeof this.debug ) {
                this.debug = false;
                $('#node-config-input-debug').prop( 'checked', false );
            }
        },
        oneditsave: function() {
        }
    });

    var loadItemSelectors = function( node ) {
        try {
            console.log("ezlo item: loading hub data for",node.id,"hub",node.hub);
            $.getJSON({
                url: "devicelist/" + String( node.hub ),
                timeout: 30000
            }).done( data => {
                console.log("request success");
                let currItem = data.items[ node.itemId ];
                console.log("current item is",currItem);
                /* First, fill the device menu with current devices */
                var $el = $( 'select#ezlo-device' ).empty()
                    .append( '<option value="">(choose device)</option>' );
                for ( var [ deviceId, d ] of Object.entries( data.devices || {} ) ) {
                    $( '<option></option>' ).val( deviceId )
                        .text( d.name || deviceId )
                        .appendTo( $el );
                }
                var $il = $( 'select#ezlo-item' )
                    .val( "" )
                    .prop( 'disabled', true )
                    .on( 'change', ( ev ) => {
                        /* Item selected; copy to ItemID field */
                        const $e = $( event.currentTarget );
                        const id = $e.val();
                        node.itemId = id;
                        $( '#node-input-itemId' ).val( id ).trigger( 'change' );
                        const deviceId = data.items[ id ]?.deviceId || "";
                        $( '#node-input-description' )
                            .val( `${String( data.devices[ deviceId ]?.name || deviceId )} ${String( data.items[ id ]?.name || id )}` )
                            .trigger( 'change' );
                    });
                var fillDeviceItems = function( deviceId ) {
                    $il.empty();
                    $( '<option value="">(choose item)</option>' )
                        .prependTo( $il );
                    for ( var [ itemId, item ] of Object.entries( data.items || {} ) ) {
                        if ( item.deviceId === deviceId ) {
                            $( '<option></option>' ).val( itemId )
                                .text( item.name )
                                .appendTo( $il );
                        }
                    }
                };
                if ( currItem ) {
                    $el.val( currItem.deviceId );
                    fillDeviceItems( currItem.deviceId );
                    $il.val( currItem._id );
                    $il.prop( 'disabled', false );
                } else if ( "" !== node.itemId ) {
                    /* Item no longer exists */
                    $( '<option value="unknown">**unknown device**</option>' )
                        .appendTo( $el );
                    $el.val( "unknown" );
                    $( '<option></option>' ).val( node.itemId )
                        .text( node.itemId + " (unknown item)" );
                    $il.val( node.itemId ).prop( 'disabled', false );
                } else {
                    $el.val( "" );
                    $il.val( "" ).prop( 'disabled', true );
                }
                $el.on( 'change', () => {
                    $il.empty();
                    var deviceId = $( 'select#ezlo-device' ).val();
                    if ( "" !== deviceId ) {
                        fillDeviceItems( deviceId );
                        $il.val( "" ).prop( 'disabled', false );
                    } else {
                        $il.val( "" ).prop( 'disabled', true );
                    }
                });
            }).fail( ( jqxhr, textStatus, error ) => {
                console.error( "request failed:", jqxhr, textStatus, error );
            });
        } catch ( err ) {
            $( 'select#ezlo-device' ).empty();
            $( 'select#ezlo-item' ).empty();
            console.error( err );
        }
    }

    RED.nodes.registerType('ezlo item',{
        category: 'ezlo',
        defaults: {
            hub: { type:"ezlo-hub", required: true},
            itemId: { value: "", required: true },
            description: { value: "", required: false },
            responseType: { value: "", required: false }
        },
        color:"#7fcfcf",
        inputs: 1,
        outputs: 1,
        icon: "bridge.svg",
        label: function() {
            return this.description || this.itemId || "ezlo item";
        },
        labelStyle: function() {
            return this.description?"node_label_italic":"";
        },
        oneditprepare: function() {
            const node = this;
            $("#node-input-hub").on( "change", function(d) {
                loadItemSelectors( node );
            });
            loadItemSelectors( node );
        },
        oneditsave: function() {
        }
    });

    var loadDeviceSelector = function( node ) {
        try {
            console.log("ezlo device: loading device data for",node.id,"hub",node.hub);
            $.getJSON({
                url: "devicelist/" + String( node.hub ),
                timeout: 30000
            }).done( data => {
                console.log("ezlo device: request success");
                let currDevice = data.devices[ node.deviceId ];
                console.log("ezlo device: current device is", currDevice);
                /* Fill the device menu with current devices */
                var $el = $( 'select#ezlo-device' ).empty()
                    .append( '<option value="">(choose device)</option>' );
                for ( var [ deviceId, d ] of Object.entries( data.devices || {} ) ) {
                    $( '<option></option>' ).val( deviceId )
                        .text( d.name || deviceId )
                        .appendTo( $el );
                }
                if ( currDevice ) {
                    $el.val( currDevice._id );
                } else if ( node.deviceId ) {
                    $( '<option></option>' )
                        .val( node.deviceId )
                        .text( node.deviceId + " (unknown device)" )
                        .appendTo( $el );
                    $el.val( node.deviceId );
                } else {
                    $el.val( "" );
                }
                $el.on( 'change', ( ev ) => {
                    var $e = $( ev.currentTarget );
                    var id = $e.val();
                    node.deviceId = id;
                    $( '#node-input-deviceId' ).val( id ).trigger( 'change' );
                    $( '#node-input-description' )
                        .val( data.devices[ id ]?.name || id )
                        .trigger( 'change' );
                });
            }).fail( ( jqxhr, textStatus, error ) => {
                console.error( "request failed:", jqxhr, textStatus, error );
            });
        } catch ( err ) {
            $( 'select#ezlo-device' ).empty();
            console.error( err );
        }
    }

    RED.nodes.registerType('ezlo device',{
        category: 'ezlo',
        defaults: {
            hub: { type:"ezlo-hub", required: true},
            deviceId: { value: "", required: true },
            description: { value: "", required: false }
        },
        color:"#7fcfcf",
        inputs: 1,
        outputs: 1,
        icon: "bridge.svg",
        label: function() {
            return this.description || this.deviceId || "ezlo device";
        },
        labelStyle: function() {
            return this.description?"node_label_italic":"";
        },
        oneditprepare: function() {
            const node = this;
            $("#node-input-hub").on( "change", function(d) {
                loadDeviceSelector( node );
            });
            loadDeviceSelector( node );
        },
        oneditsave: function() {
        }
    });

    RED.nodes.registerType('ezlo house mode',{
        category: 'ezlo',
        defaults: {
            hub: { type:"ezlo-hub", required: true },
            responseType: { value: "", required: false }
        },
        color:"#7fcfcf",
        inputs: 1,
        outputs: 1,
        icon: "bridge.svg",
        label: function() {
            //console.log("in house mode label func, this is",this);
            return "House Mode";
        },
        labelStyle: function() {
            return "node_label_italic";
        },
        oneditprepare: function() {
            const node = this;
            $("#node-input-hub").on( "change", function(d) {
            });
            if ( "undefined" === typeof this.responseType ) {
                this.responseType = "";
                $("#node-input-responseType").val( "" );
            }
        },
        oneditsave: function() {
        }
    });

    RED.nodes.registerType('ezlo hub info',{
        category: 'ezlo',
        defaults: {
            hub: { type:"ezlo-hub", required: true}
        },
        color:"#7fcfcf",
        inputs: 1,
        outputs: 1,
        icon: "bridge.svg",
        label: function() {
            return this.name || "ezlo hub";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            const node = this;
            $("#node-input-hub").on( "change", function(d) {
            });
        },
        oneditsave: function() {
        }
    });
})();
</script>
